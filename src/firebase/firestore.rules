rules_version = '2';
service cloud.firestore {
    match /databases/{database}/documents {
        function hasTimestamp(field) {
            return request.resource.data[field] == request.time;
        }

        function isAuthenticated(id) {
            return request.auth != null && request.auth.uid == id;
        }

        function affectedKeys() {
            return request.resource.data.diff(resource.data).affectedKeys();
        }

        function isTeacher() {
            return exists(/databases/$(database)/documents/teachers/$(request.auth.uid));
        }

        function getStudent(uid) {
            let data = get(/databases/$(database)/documents/studentMappingUid/$(uid)).data;
            return get(/databases/$(database)/documents/students/$(data.studentId));
        }

        function getParticipation(id) {
            return get(/databases/$(database)/documents/participation/$(id));
        }

        function isTeacherSchool(participationId) {
            let participation = getParticipation(participationId);
            return participation != null && isAuthenticated(participation.data.teacher);
        }

        function isMyStudent(studentId) {
            let student = get(/databases/$(database)/documents/students/$(studentId));
            return student != null
                && student.data.participationId != null
                && isTeacherSchool(student.data.participationId)
        }

        match /contests/{contest} {
            allow read: if request.auth != null;
        }

        match /participations/{participation} {
            function isStudentSchool() {
                let student = getStudent(request.auth.uid);
                return student != null && isAuthenticated(student.data.uid)
                    && student.data.participationId == participation
                    && student.data.token == resource.data.token;
            }

            allow read: if isStudentSchool() || isTeacher();
            allow update: if isAuthenticated(resource.data.teacher) && affectedKeys().hasOnly(['token', 'startingTime', 'finalized']);
        }

        match /participationMapping/{token} {
            function checkToken(participationId) {
              let participation = getAfter(/databases/$(database)/documents/participations/$(participationId));
              return participation != null
                  && participation.data.token == token
                  && participation.data.startingTime == request.resource.data.startingTime
                  && participation.data.contestId == request.resource.data.contestId;
            }
            allow get: if request.auth != null;
            allow create: if isTeacher() && isTeacherSchool(request.resource.data.participationId) && checkToken(request.resource.data.participationId);
        }

        match /solutions/{solution} {
            allow read: if isTeacher();
        }

        function studentHash(student) {
            let data = student.personalInformation;
            let joined = [data.name, data.surname, data.classYear, data.classSection, student.token].join('$').lower();
            return hashing.sha256(joined).toHexString();
        }

        match /students/{student} {

            function checkEndingTime(participationId) {
                let participation = getParticipation(participationId);
                let contest = get(/databases/$(database)/documents/contests/$(participation.data.contestId));
                let startingTime = participation.data.startingTime.toMillis();
                let totalTime = contest.data.duration * 60000 + 30000;
                let endingTime = startingTime + totalTime;
                return request.time.toMillis() <= endingTime;
            }

            function checkToken(participationId) {
                let participation = getParticipation(participationId);
                return participation != null
                    && participation.data.token != null
                    && participation.data.token == request.resource.data.token
                    && participation.data.startingTime == request.resource.data.startedAt
                    && participation.data.contestId == request.resource.data.contestId;
            }

            function checkVariant(data) {
                let hash = data.contestId + '-' + studentHash(data)[0: 3];
                let mapping = get(/databases/$(database)/documents/variantMapping/$(hash));
                return mapping != null
                    && mapping.data.variant == data.variant;
            }

            function canStudentCreate() {
                return isAuthenticated(request.resource.data.uid)
                    && request.resource.data.participationId != null
                    && request.resource.data.personalInformation != null
                    && request.resource.data.contestId != null
                    && checkToken(request.resource.data.participationId)
                    && checkVariant(request.resource.data);
            }

            function canStudentUpdate() {
                let keys = affectedKeys();
                return isAuthenticated(resource.data.uid)
                    && checkToken(resource.data.participationId)
                    && checkEndingTime(resource.data.participationId)
                    && keys.hasOnly(['answers', 'updatedAt'])
                    && hasTimestamp('updatedAt');
            }

            function canTeacherUpdate() {
                let keys = affectedKeys();
                return isTeacherSchool(resource.data.participationId)
                    && !keys.hasAny(['participationId', 'createdAt'])
                    && hasTimestamp('updatedAt');
            }

            allow read: if isAuthenticated(resource.data.uid) || isTeacherSchool(resource.data.participationId);
            allow create: if (canStudentCreate() || isTeacherSchool(request.resource.data.participationId)) /* TODO && hasTimestamp('createdAt') */;
            allow update: if canStudentUpdate() || canTeacherUpdate();
            allow delete: if isTeacherSchool(resource.data.participationId);
        }

        match /studentMappingHash/{id} {
            function canCreateStudent() {
                let student = getAfter(/databases/$(database)/documents/students/$(request.resource.data.studentId));
                return student != null
                    && isAuthenticated(student.data.uid)
                    && student.data.personalInformation != null
                    && studentHash(student.data) == id;
            }
            function canCreateTeacher() {
                return isTeacher() && isMyStudent(request.resource.data.studentId);
            }

            allow read: if request.auth != null;
            allow create, update: if canCreateStudent() || canCreateTeacher();
            allow delete: if isMyStudent(resource.data.studentId);
        }

        match /studentMappingUid/{id} {
            function canCreateStudent() {
                let student = getAfter(/databases/$(database)/documents/students/$(request.resource.data.studentId));
                return student != null
                    && isAuthenticated(student.data.uid)
                    && isAuthenticated(id);
            }
            function canCreateTeacher() {
                return isTeacher() && isMyStudent(request.resource.data.studentId);
            }

            allow read: if request.auth != null;
            allow create, update: if canCreateStudent() || canCreateTeacher();
            allow delete: if isMyStudent(resource.data.studentId);
        }

        match /studentRestore/{uid} {
            function canStudentCreate() {
                let student = get(/databases/$(database)/documents/students/$(request.resource.data.studentId));
                let participation = getParticipation(request.resource.data.participationId);
                return participation != null
                    && student != null
                    && participation.data.token == request.resource.data.token
                    && student.data.participationId == request.resource.data.participationId
                    && request.auth.uid == uid;
            }
            allow read: if isTeacher() || request.auth.uid == uid;
            allow create,update: if canStudentCreate();
            allow delete: if isMyStudent(resource.data.studentId);
        }

        match /submissions/{submission} {
            allow list: if isTeacher();
            allow get: if isAuthenticated(resource.data.uid);
            allow create: if isAuthenticated(request.resource.data.uid) && hasTimestamp('submittedAt');
        }

        match /teachers/{teacher} {
            allow read: if request.auth != null && request.auth.token.email_verified;
        }

        function canStudentReadVariant(variant) {
            let student = getStudent(request.auth.uid);
            return student != null
                && isAuthenticated(student.data.uid)
                && student.data.variant == variant
                && student.data.startedAt <= request.time;
        }

        match /statements/{variant} {
            allow read: if canStudentReadVariant(variant) || isTeacher();
        }

        match /variants/{variant} {
            allow read: if canStudentReadVariant(variant) || isTeacher();
        }

        match /variantMapping/{hash} {
            allow read: if request.auth != null;
        }

        match /pdfs/{variant} {
            allow read: if request.auth != null && isTeacher();
        }
    }
}
